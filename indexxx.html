<!DOCTYPE html>
<html>
<head>
    <title>Live Video Streaming</title>
</head>
<body>
    <h1>Live Video Streaming</h1>
    <form action="/connect" method="post">
        <label for="peer_id">Peer ID:</label>
        <input type="text" name="peer_id" id="peer_id" required>
        <input type="submit" value="Connect">
    </form>
    <video id="remote_video" autoplay playsinline controls></video>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adapterjs/0.16.3/adapter.js"></script>
    <script>
        const peer_id = document.getElementById('peer_id').value;
        const remote_video = document.getElementById('remote_video');
        const ws = new WebSocket('{{ ws_url }}');

        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            if (message.ice) {
                await pc.addIceCandidate(message.ice);
            } else if (message.answer) {
                const remoteDesc = new RTCSessionDescription(message.answer);
                await pc.setRemoteDescription(remoteDesc);
            } else if (message.offer) {
                const remoteDesc = new RTCSessionDescription(message.offer);
                await pc.setRemoteDescription(remoteDesc);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ 'answer': answer, 'peer_id': peer_id }));
            }
        };

        const pc = new RTCPeerConnection();

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                ws.send(JSON.stringify({ 'ice': event.candidate, 'peer_id': peer_id }));
            }
        };

        pc.ontrack = (event) => {
            remote_video.srcObject = event.streams[0];
        };
    </script>
</body>
</html>
